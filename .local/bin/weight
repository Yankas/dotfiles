#!/usr/bin/env python
import sys, re
from datetime import datetime


weight_file = "/doc/body/weight"

def read_all(file):
    with open(file) as f: return f.read()

def main():
    if(len(sys.argv) < 2):
        print("ERROR: Argument required")
        return 1
        
    arg = sys.argv[1]
    match arg:
        case "list":
            import csv
            with open(weight_file, newline='') as csvfile:
                dataset = csv.reader(csvfile, delimiter='|')
                next(dataset, None) # ignore header
                print("Date\t\tWeight\t\tBMI")
                print("-------------------------------------")
                for row in dataset:
                    time = row[0][0:10]
                    weight = row[1]
                    height_in_m = float(read_all("/doc/body/height")) / 100
                    bmi = round(float(weight) / height_in_m**2, 2)
                    print(f"{time}\t{weight}kg\t\t{bmi}"  )
        case "edit":
            import subprocess,os
            editor = os.environ['EDITOR']
            subprocess.run([editor, weight_file])
        case weight if re.match(r"\d+\.*d*|.\d+", weight):
            file = open(weight_file, 'a')
            date = datetime.now().strftime("%Y-%m-%dT%H:%M:%S")
            file.write(f'\n{date}|{weight}')
        case _:
            print("Invalid parameter")
            
if __name__ == "__main__":
   main()